name: GDPR/Merge Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment where db migration will be done (dev, preprod, prod)"
        required: true
        type: choice
        options:
          - dev
      app:
        description: "Application DB to migrated ('gdpr' or 'merge')"
        required: true
        type: choice
        options:
          - gdpr
          - merge
      ssm_prefix:
        description: "SSM Parameter Store prefix for legacy RDS credentials"
        required: true
        type: string

jobs:
  db-migration:
    name: Run RDS Migration
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: eu-west-2

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.26.0'
        id: kubectl_install

      - name: Setup helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      # Configure kubeconfig (assuming EKS)
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region eu-west-2 \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      # Fetch DB credentials from SSM (legacy account)
      - name: Get RDS credentials from SSM
        id: rds_creds
        run: |
          DB_USER=$(aws ssm get-parameter --with-decryption --name "${{ github.event.inputs.ssm_prefix }}/db-username" --query "Parameter.Value" --output text)
          DB_PASS=$(aws ssm get-parameter --with-decryption --name "${{ github.event.inputs.ssm_prefix }}/admin_password" --query "Parameter.Value" --output text)
          DB_NAME=$(aws ssm get-parameter --with-decryption --name "${{ github.event.inputs.ssm_prefix }}/db-name" --query "Parameter.Value" --output text)
          DB_HOST=$(aws ssm get-parameter --with-decryption --name "${{ github.event.inputs.ssm_prefix }}/db-endpoint" --query "Parameter.Value" --output text)

          echo "db_user=$DB_USER" >> $GITHUB_OUTPUT
          echo "db_pass=$DB_PASS" >> $GITHUB_OUTPUT
          echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT
          echo "db_host=$DB_HOST" >> $GITHUB_OUTPUT

      # Create Kubernetes Secret for the job
      - name: Create Kubernetes Secret
        run: |
          kubectl delete secret legacy-rds-creds --ignore-not-found -n hmpps-delius-core-${{ github.event.inputs.environment }}
          kubectl create secret generic legacy-rds-creds \
            --from-literal=username=${{ steps.rds_creds.outputs.db_user }} \
            --from-literal=password=${{ steps.rds_creds.outputs.db_pass }} \
            --from-literal=database=${{ steps.rds_creds.outputs.db_name }} \
            --from-literal=host=${{ steps.rds_creds.outputs.db_host }} \
            -n ${{ github.event.inputs.environment }}

      # Install Helm chart for migration job
      - name: Deploy Migration Job via Helm
        run: |
          helm upgrade --install db-migration ./jobs/migrate-db \
            --namespace hmpps-delius-core-${{ github.event.inputs.environment }} \
            --set appName=${{ github.event.inputs.app }} \
            --set job.environment=${{ github.event.inputs.environment }} \
            --wait
