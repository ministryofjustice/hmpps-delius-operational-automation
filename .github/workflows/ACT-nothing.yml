name: "ACT: Nothing"
on:
  schedule:
    - cron: '0 17 * * MON-FRI'  # BST Runs  
    - cron: '0 18 * * MON-FRI'  # GMT Runs
    - cron: '0 14 * * MON-FRI'
jobs:

  prepare-run-matrix:
    runs-on: ubuntu-latest
    outputs:
      scheduled_matrix: ${{ steps.filter-backups-schedule.outputs.scheduling_matrix }}
      type: object
    steps:

      - name: Checkout Backups Schedule
        uses: actions/checkout@v4
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: |
             .github/workflows/ACT-nothing-schedule.json
          path: operations
          ref: DBA-908
          fetch-depth: 0

      - name: Checkout London Timezone Script
        uses: actions/checkout@v4
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: |
             common/files/convert_cron_expression_to_London.py
          path: operations
          ref: DBA-908
          fetch-depth: 0

      - name: Get Timezone Currently in Effect in London
        id: filter-backups-schedule
        run: |
             CRONSCHEDULE=$(python3 operations/common/files/convert_cron_expression_to_London.py "${{ github.event.schedule }}")
             echo "Matching ${CRONSCHEDULE}"
             echo "Inside "
             cat operations/.github/workflows/ACT-nothing-schedule.json
             SCHEDULED_JSON=$(jq --arg CRONSCHEDULE "$CRONSCHEDULE" '[.[] | select (.CronSchedule==$CRONSCHEDULE) | {"Message"}]' operations/.github/workflows/ACT-nothing-schedule.json | jq -c '{include: .}')
             echo "${SCHEDULED_JSON}"
             echo "scheduling_matrix="$(echo ${SCHEDULED_JSON} | sed 's/ //g') >> $GITHUB_OUTPUT

  report-json:
    needs: prepare-run-matrix
    runs-on: ubuntu-latest
    steps:
      # - name: Show JSON
      #   run: |
      #     echo "${{ needs.prepare-run-matrix.outputs.scheduled_matrix }}"
          
      # - name: Validate JSON
      #   run: |
      #     echo "${{ needs.prepare-run-matrix.outputs.scheduled_matrix }}" \
      #       | jq . >/dev/null && echo "JSON is valid" || echo "JSON is invalid" 

      - name: Validate Include
        run: |
          echo "${{ fromJson(needs.prepare-run-matrix.outputs.scheduled_matrix).include[0] }}" 

  report-schedule-backup:
    needs: prepare-run-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.prepare-run-matrix.outputs.scheduled_matrix).include[0]  }}
    steps:
      - name: Report Backups Scheduled to Run
        id: report-run
        run: |
              echo "Running Backups for these targets: ${{ needs.prepare-run-matrix.outputs.scheduled_matrix }}"
 
  report-no-scheduled-backup:
    needs: prepare-run-matrix
    runs-on: ubuntu-latest
    if: ${{ ! fromJson(needs.prepare-run-matrix.outputs.scheduled_matrix).include[0]  }}
    steps:
        - name: Report Nothing to Do
          id: report-no-run
          run: |
              echo "No targets scheduled for backup run."

  run-backup:
    needs: prepare-run-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.prepare-run-matrix.outputs.scheduled_matrix).include[0]  }}
    steps:
        - name: Report Nothing to Do
          id: report-no-run
          run: |
              echo "I would run the back now if this was a proper action."

