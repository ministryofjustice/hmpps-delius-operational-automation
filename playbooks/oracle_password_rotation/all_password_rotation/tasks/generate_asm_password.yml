 
- name: Set Application (Delius)
  set_fact:
      application: "{{ ( 'delius-core' if (environment_name == 'delius-core-dev') else 'delius' ) + '/' + db_type + '-database' }}"
  when: not environment_name is search('eng.*')

- name: Set Application (Engineering)
  set_fact:
      application: "engineering/{{ db_type }}-database"      
  when: environment_name is search('eng.*')

- name: Get New Password for ASM
  include_tasks: create_random_password.yml

# Allow retries in case of password change storm
- name: Record New ASM Password in Parameter Store
  community.aws.aws_ssm_parameter_store:
      name: "/{{ environment_name }}/{{ application }}/db/oradb_asmsnmp_password"
      value: "{{ new_password }}"
      overwrite_value: changed
      string_type: "SecureString"
      region: "{{ region }}"
      aws_access_key: "{{ assumed_role.sts_creds.access_key }}"
      aws_secret_key: "{{ assumed_role.sts_creds.secret_key }}"
      security_token: "{{ assumed_role.sts_creds.session_token }}"
  retries: 4
  delay: "{{ 60 | random }}"
  throttle: 1