- name: Initialise Secrets Dictionary And Variables
  set_fact:
    secretsmanager_passwords_dict: {}


- name: DD Secret Name
  debug:
     var: secret_name

- name: Setup Temporary Secrets Dictionary
  set_fact:
    secret_password_dict:
      account:
        secret: "{{ secret_name }}"

- name: DD Secrets Dictionary
  debug:
     var: secret_password_dict

# - name: Add Secret Account Name and Role Name To Secret Dictionary For OEM databases
#   set_fact:
#     secret_password_dict: "{{ secret_password_dict |  combine({ 'account': { 'account_name':  'hmpps-oem-' + aws_environment, 'assume_role_name': 'EC2OracleEnterpriseManagementSecretsRole' }}, recursive=true) }}"
#   when: oem_db_name is defined

- name: Add User {{ db_username }} To Secret Dictionary
  set_fact:
    secret_password_dict: "{{ secret_password_dict |  combine({ 'account': { 'users': [{db_username: new_password | default(None) }] }}, recursive=true) }}"

- name: DD Secrets Dictionary
  debug:
     var: secret_password_dict

- name: Whoami
  shell: aws sts get-caller-identity
  register: get_caller_identity

- debug:
     var: get_caller_identity

- name: Environment
  shell: env
  register: get_my_env

- debug:
     var: get_my_env
     
- name: Update {{ db_username }} Password In Secrets
  import_role:
    name: secretsmanager-passwords
  vars:
    secretsmanager_passwords: "{{ secret_password_dict }}"
