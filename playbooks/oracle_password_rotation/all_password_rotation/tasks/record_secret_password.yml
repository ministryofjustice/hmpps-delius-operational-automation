- name: Retrieve All Passwords
  set_fact:
    secrets: "{{ lookup('amazon.aws.aws_secret', '{{ secret_name }}', region=region) }}"

- name: Combine New Password
  set_fact:
    secrets: "{{ secrets | default([]) | combine({ db_username: new_password }) }}"

# There is a potential for this task to fail due to AWS throttling, so allow it to retry a few times if needed
- name: Record New Password in Secret Manager
  community.aws.aws_secret:
    name: "{{ secret_name }}"
    state: present
    secret_type: "string"
    secret: "{{ secrets | to_json }}"
    region: "{{ region }}"
  retries: 4
  delay: "{{ 60 | random }}"
  throttle: 1
