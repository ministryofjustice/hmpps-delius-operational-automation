- name: Set RMAN Secret Name
  set_fact:
    secret_name: "{{ rman_secretsmanager_passwords['catalog']['secret'] }}"
  no_log: true

- name: Set Existing RMAN Password In Variable
  set_fact:
    existing_rman_password: "{{ lookup('amazon.aws.aws_secret', '{{ secret_name }}', region='eu-west-2') | from_json | json_query('rcvcatowner') }}"

- name: Get New Password for RMAN
  include_tasks: ../../all_password_rotation/tasks/create_random_password.yml

- block:
    - name: Update the secret for the RMAN password
      include_tasks: set_rman_password.yml
      vars:
        rman_password: "{{ new_password }}"

    - name: Set RMAN Password in Catalog Database
      script: set_rman_password.sh
      environment:
        DB_NAME: "{{ db_configs['RCVCAT']['rcvcat_db_name'] }}"
        SECRET_ID: "{{ rman_secretsmanager_passwords['catalog']['secret'] }}"

  when: existing_rman_password != new_password
