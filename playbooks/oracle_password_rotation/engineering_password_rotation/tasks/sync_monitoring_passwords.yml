

- community.aws.sts_assume_role:
    role_arn: "arn:aws:iam::{{ eng_dev_id if environment_name == 'engineering-dev' else eng_prod_id }}:role/terraform"
    role_session_name: "OEM-Password-Sync-for-{{ environment_name }}"
  register: assumed_engineering_role
  changed_when: false

- name: Get Existing SYSMAN Password
  set_fact:
      sysman_password: "{{ lookup('aws_ssm', '/{{ environment_name }}/engineering/oem-database/db/oradb_sysman_password', decrypt=true, aws_access_key=assumed_engineering_role.sts_creds.access_key, aws_secret_key=assumed_engineering_role.sts_creds.secret_key, aws_security_token=assumed_engineering_role.sts_creds.session_token ) }}"

- name: Update the OEM Targets to Match the SSM Parameters
  include: set_monitoring_passwords.yml
  vars:
     aws_account_id: "{{ aws_account_ids['hmpps-' + target_environment_name] }}"
     engineering_environment: "{{ environment_name.split('-')[1] }}"
     engineering_dev_id: "{{ eng_dev_id }}"
     engineering_prod_id: "{{ eng_prod_id }}"
