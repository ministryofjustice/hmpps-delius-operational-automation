- community.aws.sts_assume_role:
    role_arn: "arn:aws:iam::{{ eng_dev_id if environment_name == 'engineering-dev' else eng_prod_id }}:role/terraform"
    role_session_name: "Agent-Registration-Password-Sync-for-{{ environment_name }}"
  register: assumed_role
  changed_when: false

- name: Create New Password for Agent Registration
  include: ../../all_password_rotation/tasks/create_random_password.yml

- name: Record New Password for Agent Registration in Parameter Store
  community.aws.aws_ssm_parameter_store:
      name: "/{{ environment_name }}/engineering/oem-database/db/agent_registration_password"
      value: "{{ new_password }}"
      overwrite_value: changed
      string_type: "SecureString"
      aws_access_key: "{{ assumed_role.sts_creds.access_key }}"   
      aws_secret_key: "{{ assumed_role.sts_creds.secret_key }}"
      security_token: "{{ assumed_role.sts_creds.session_token }}"
      region: "{{ region }}"

- name: Set SYSMAN Password
  set_fact:
     oem_sysman_password:  "{{ lookup('aws_ssm', '/{{ environment_name }}/engineering/oem-database/db/oradb_sysman_password', region=region, decrypt=true, aws_access_key=assumed_role.sts_creds.access_key, aws_secret_key=assumed_role.sts_creds.secret_key, aws_security_token=assumed_role.sts_creds.session_token ) }}"

- name: Set Agent Registration Password
  shell: "{{ emctl_oem }} secure setpwd ${SYSMAN_PASSWORD} ${AGENT_REGISTRATION_PASSWORD}"
  delegate_to: "{{ groups['oem_primarydb'][0] }}"
  become: true
  become_user: oracle
  environment:
    SYSMAN_PASSWORD: "{{ oem_sysman_password }}"
    AGENT_REGISTRATION_PASSWORD: "{{ new_password }}"
