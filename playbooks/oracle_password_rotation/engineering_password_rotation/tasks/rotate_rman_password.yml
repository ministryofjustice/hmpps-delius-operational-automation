- name: Get New Password for RMAN
  include: ../../all_password_rotation/tasks/create_random_password.yml

- name: Set RMAN Password in Catalog Database
  script: set_rman_password.sh
  delegate_to: "{{ groups['rman_primarydb'][0] }}"
  become: true
  become_user: oracle
  environment:
      RMAN_PASSWORD: "{{ new_password }}"

# Exclude delius-core-non-prod as we have replaced this with individual entries for Dev
- name: Loop Through Environments and Update the SSM Parameter for the RMAN Password
  include: set_rman_password.yml
  vars:
     aws_account_id: "{{ aws_account_ids[item] }}"
     aws_account_name: "{{ item | regex_replace('^hmpps-','') }}"
     rman_password: "{{ new_password }}"
     engineering_environment: "{{ environment_name.split('-')[1] }}"
     engineering_dev_id: "{{ eng_dev_id }}"
     engineering_prod_id: "{{ eng_prod_id }}"
  loop: "{{ aws_account_ids.keys() | list }}"
  when: 
     - item is search('delius') or item is search('engineering')
     - item != 'delius-core-non-prod'  # Using delius-core-dev instead
