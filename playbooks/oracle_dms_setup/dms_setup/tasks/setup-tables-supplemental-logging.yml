- name: Include Variables for {{ dms_user_application }} Setup
  include_vars: "{{ dms_user_application }}.yml"

- name: Switch on supplemental logging on tables
  shell: 
    cmd: |
      . ~/.bash_profile
      ORACLE_SID={{ delius_primary_sid }}
      ORAENV_ASK=NO
      . oraenv > /dev/null

      sqlplus -s / as sysdba << EOF

      WHENEVER SQLERROR EXIT FAILURE
      SET ECHO OFF HEAD OFF PAGES 0 FEED OFF SERVEROUTPUT ON

      DECLARE

        v_count_log      NUMBER(1);
        v_count_table    NUMBER(1);

      BEGIN

        SELECT COUNT(*)
        INTO v_count_table
        FROM dba_tables
        WHERE table_name = UPPER('{{ object.name }}')
        AND   owner = UPPER('{{ object.owner }}');

        SELECT COUNT(*)
        INTO v_count_log
        FROM dba_log_groups
        WHERE table_name = UPPER('{{ object.name }}')
        AND   owner = UPPER('{{ object.owner }}')
        AND   log_group_type LIKE '{{ object.log_data | upper }}%LOGGING';

        IF v_count_log = 0
        THEN
          IF v_count_table = 1
          THEN
            EXECUTE IMMEDIATE 'ALTER TABLE {{ object.owner }}.{{ object.name }} ADD SUPPLEMENTAL LOG DATA ({{ object.log_data }}) COLUMNS'; 
            dbms_output.put_line('Supplemental logging switched on {{ object.owner }}.{{ object.name }}');
          ELSE
            dbms_output.put_line('Table {{ object.owner }}.{{ object.name }} does not exist');
          END IF;
        ELSE
          dbms_output.put_line('Supplemental logging already switched on {{ object.owner }}.{{ object.name }}');
        END IF;

      END;
      /
      EOF
  delegate_to: "{{ delius_primary_host }}"
  changed_when: false
  no_log: true
  with_items: "{{ dms_tables }}"
  register: supplemental_output
  loop_control:
      loop_var: object

- name: Supplemental output
  debug:
    msg: "{{ sql_out.stdout }}" 
  with_items: "{{ supplemental_output.results }}"
  loop_control:
    label: "Supplemental Output"
    loop_var: sql_out
