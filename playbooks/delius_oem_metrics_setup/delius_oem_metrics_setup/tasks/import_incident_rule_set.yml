---
- name: Import Incident Rule Set for Delius Targets
  block:
    # EMCLI Login script contains a password so ensure it is not readable by other users
    - name: Copy EMCLI Login scripts
      template:
        src: "{{ playbook_dir }}/../../common/tenmplates/emcli_login.sh.j2"
        dest: "{{ stage }}/import_inclident_rule_set.sh"
        mode: "0700"

    - name: Copy Incident Rule Set Import scripts
      template:
        src: import_incident_rule_set.sh.j2
        dest: "{{ stage }}/import_inclident_rule_set.sh"
        mode: "0700"

    - name: Copy Incident Rule definition
      copy:
        src: rule_set.xml
        dest: "{{ stage }}/rule_set.xml"
        mode: "0600"

    - name: Run Incident Rule Set Import
      ansible.builtin.shell: |
        echo "running emcli_login.sh"
        {{ stage }}/emcli_login.sh
        echo "running import_incident_rule_set.sh"
        {{ stage }}/import_incident_rule_set.sh

  always:
    - name: Remove Incident Rule Set scripts from Staging Area
      ansible.builtin.file:
        path: "{{ stage }}/{{ item }}"
        state: absent
      loop:
        - emcli_login.sh
        - import_incident_rule_set.sh
        - rule_set.xml
