- name: Manage whether standby databases are created
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:

    - name: Initialise variables on localhost to be used elewhere
      set_fact:
        type: "{{ duplicate_target | regex_replace('(^.*)_.*$','\\1') }}"
        primary_host: "nohost"
        standby_host: "nohost"
        create_standby: false
        ha_count: 0
        fsfo_observer_target: "disabled"

    - name: Set facts if delius
      set_fact:
        primary_host: "delius_primarydb"
        standby_host: "delius_standbydb2"
        create_standby: true
        ha_count: "{{ database.delius.high_availability_count | int }}"
        fsfo_observer_target: "{{ hostvars[groups['delius_primarydb'][0]]['fsfo_mode']  | default('disabled')  | lower }}"
      when: database.delius.high_availability_count | int == 2 and type == 'delius'

    - name: Set facts if mis
      set_fact:
        primary_host: "mis_primarydb"
        standby_host: "mis_standbydb2"
        create_standby: true
        ha_count: "{{ database.mis.high_availability_count | int }}"
        fsfo_observer_target: "{{ hostvars[groups['mis_primarydb'][0]]['fsfo_mode']  | default('disabled') | lower }}"
      when: database.mis.high_availability_count | int == 2 and type == 'mis'

- name: Create standby database
  import_playbook: build-ha.yml 
  vars:
      primary: "{{ hostvars['localhost']['primary_host'] }}" 
      standby: "{{ hostvars['localhost']['standby_host'] }}" 
      method: "{{ procedure | default() }}" 
      ssm_option: "{{ ssm_parameter | default() }}" 
      high_availability_count: "{{ hostvars['localhost']['ha_count'] }}" 
      fsfo_mode: "{{ hostvars['localhost']['fsfo_observer_target'] }}" 
      standby_number: 2 
  when:  hostvars['localhost']['create_standby']

- name: Update ssm parameter only when no standby databases to be created
  hosts: "{{ duplicate_target }}"
  gather_facts: no
  become: yes
  become_user: oracle
  gather_facts: no
  tasks:

    - name: Update ssm parameter to not required
      shell: |
        . /etc/environment 
        aws ssm put-parameter --region ${REGION} --value "NotRequiredHA" --name "{{ ssm_parameter }}" --overwrite --type String
      when: not hostvars['localhost']['create_standby'] and ssm_parameter is defined and ssm_parameter | length > 0

- name: Stop database monitoring blackout
  import_playbook: ../oem-blackout/playbook.yml 
  vars:
     target: "{{ duplicate_target.split('_')[0] + '_dbs' }}"  
     action: "stop" 
     object_type: "all" 
     blackout: "DUPLICATE_{{ environment_name }}" 
     duration: ""
  when: procedure == 'post'