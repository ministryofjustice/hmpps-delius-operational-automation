---
- name: Delius ND Parameters
  hosts: "{{ duplicate_target }}"
  gather_facts: no
  become: yes
  become_user: oracle

  tasks:
    # If we are duplicating into the Stage or Pre-Prod environments we should update the
    # ND Parameters to set URLs appropriate to Pre-Prod (Stage uses the same URLs as Pre-Prod).
    # This is only required in these environments as they will be typically cloning from
    # Production and the values need to be updated.
    # For lower environments we will typically be migrating and the existing values should
    # then be left as-is or changed manually post-migration.
    - name: Convert Delius ND Parameters
      when: environment_name in ['delius-core-stage','delius-core-preprod']
      block:
        - name: Set ND Parameters
          script: update_nd_parameters.sh
          register: update_nd_parameters

      rescue:
        - name: Send error notification message via Slack
          community.general.slack:
            token: "{{ slack_token }}"
            msg: "Update ND Parameters failed.  Ignoring errors and continuing with duplication tasks."
            channel: "#delius-aws-oracle-dev-alerts"
            username: "Delius Database Duplicate on {{ inventory_hostname }}"
            icon_emoji: ":sign-warning:"
          when: update_nd_parameters.rc != 0
          delegate_to: localhost
          become: no
          ignore_errors: true
