---
- name: Delius User Datasets
  hosts: '{{ duplicate_target }}'
  gather_facts: no
  become: yes
  become_user: oracle

  tasks:

  - name: Get Slack Token
    shell: aws ssm get-parameter --name manual-ops-alerts-slack-token --region {{ region }} --output text --with-decryption --query Parameter.Value || aws ssm get-parameter --name /alfresco/slack/token --region {{ region }} --output text --with-decryption --query Parameter.Value
    register: getslacktoken
    changed_when: false

  - block:

      - name: Keep copy of data required for stub users
        script: keep_datasets.sh
        register: keep_datasets

    rescue:

      - name: Send error notification message via Slack
        community.general.slack:
          token: "{{ getslacktoken.stdout }}"
          msg: "Keeping Delius dataset failed.  Ignoring errors and continuing with duplication tasks."
          channel: "#delius-aws-oracle-dev-alerts"
          username: 'Delius Database Duplicate on {{ inventory_hostname }}'
          icon_emoji: ':sign-warning:'
        when: keep_datasets.rc != 0
        delegate_to: localhost
        become: no
        ignore_errors: true

    when: action == 'keep'

  - block:
  
      - name: Copy data required for stub users
        script: copy_datasets.sh
        register: copy_datasets

      - name: Output copy results
        debug: var=copy_datasets.stdout

    rescue:

      - name: Send error notification message via Slack
        community.general.slack:
          token: "{{ getslacktoken.stdout }}"
          msg: "Copying Delius dataset failed.  Ignoring errors and continuing with duplication tasks."
          channel: "#delius-aws-oracle-dev-alerts"
          username: 'Delius Database Duplicate on {{ inventory_hostname }}'
          icon_emoji: ':sign-warning:'
        when: copy_datasets.rc != 0
        delegate_to: localhost
        become: no
        ignore_errors: true

    when: action == 'copy'
