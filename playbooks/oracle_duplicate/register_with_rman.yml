---
# Note that there are no separate RMAN password parameters for MIS: The Delius parameter is used for all databases.
- name: Get RMAN password
  shell: ". /etc/environment && aws ssm get-parameters --region ${REGION} --with-decryption --name /${HMPPS_ENVIRONMENT}/${APPLICATION}/oracle-db-operation/rman/rman_password | jq -r '.Parameters[].Value'"
  changed_when: false
  register: rman_password
  no_log: true

# Ignore RMAN-20002 when database has already been registered
- name: Register Database with RMAN Catalog
  shell: |
         . ~/.bash_profile
         echo "register database;" | rman target / catalog rman19c/${PASSWORD}@{{ catalog }}
  environment:
     PASSWORD: "{{ rman_password.stdout }}"
  register: register_database
  failed_when:
       - register_database.rc | int > 0
       - not register_database.stdout is search(".*RMAN-20002.*")
  changed_when:
       - register_database.rc | int == 0
       - register_database is search(".*database registered in recovery catalog.*")