# If we are restarting replication (as opposed to resuming),
# we need to provide:
# (1) the SCN for restarting Audited Interaction replication to avoid replicating data which is already in the
#     repository.   This is normally the SCN corresponding to the startup of the client database following
#     a refresh or flashback operation.
# (2) the Date/Time for restarting User replication to avoid replicating user updates which have already been
#     sent to the client.  This is normally the date/time of the latest update of any record in the USER_
#     table on the client.
- name: Validate Restart Parameters
  fail:
    msg: "When restarting a replication client, the lower bound SCN for audited interaction, and lower bound date for User replication must be provided"
  when:
    - replication_action == 'restart'
    - audit_cdc_scn == ''
    - audited_interaction_client

- name: Get Replication Task Details
  include_tasks: get_task_details.yml

# If we do not find an Audited Interaction replication tasks then this environment is not configured as a client or repository
# and no further action is needed
- name: Skip Message
  debug:
    msg: "This environment is not configured as an Audited Interaction data client or repository.  No action taken."
  when: get_audited_interaction_task_arn == ''

- name: Perform Requested Actions on Replication Tasks
  when: get_audited_interaction_task_arn != ''
  block:

    - name: Wait for Audit Replication to Finish
      include_tasks: wait_for_zero_throughput.yml
      when: replication_action == 'stop'

    - name: Stop Replication Tasks
      include_tasks: stop_tasks.yml
      when: (replication_action == 'restart') or (replication_action == 'stop') or (replication_action == 'resume')

    - name: Resume Replication Tasks
      include_tasks: resume_tasks.yml
      when: replication_action == 'resume'

    - name: Restart Replication Tasks
      include_tasks: restart_tasks.yml
      when: replication_action == 'restart'
