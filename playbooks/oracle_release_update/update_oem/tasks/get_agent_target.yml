---
# When running Ansible using Codebuild the SSM Agent inventory will override the Ansible inventory which means that the hostnames
# used will not match the hostnames as defined within OEM.  
# As a workaround, this play will directly reference the Ansible inventory file to get the hostname to use as the agent target.

# If inside of AWS then we will be running this in an engineering environment and the is_aws_environment would not have
# been defined within this *engineering* environment (it will have been set on the Delius environment instead)
- name: Get Engineering Environment Hostnames
  when: 
     - environment_name == 'engineering-dev' or environment_name == 'engineering-prod'
     - hostvars.localhost.is_aws_environment is not defined
  block:

      - name: Undo Sed Operation on Ansible Inventory to get the FQDN of the Host
        set_fact:
         agent_host: "{{ groups[target_host][0] | regex_replace('eng-(dev|prod)-(.*)','\\2.engineering-\\1.probation.hmpps.dsd.io') }}"

# If outside of AWS then this will not be running in an engineering environment and is_aws_environment would be set false
- name: Outside AWS Use the Host Name as the Agent Host
  when: 
     - environment_name != 'engineering-dev' 
     - environment_name != 'engineering-prod'
     - not hostvars.localhost.is_aws_environment
  block:

      - name: Use the Target Host as the Agent Host
        set_fact:
         agent_host: "{{ target_host }}"

- name: Report Agent
  debug:
      msg: "Updating OEM targets registered with agent on {{ agent_host }}"